<html lang="en">
<head>
  <title>Home</title>
  <script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.js"></script>
  <style>
      html, body {
          margin: 0;
          background: black;
          color: white;
      }

      section {
          display: flex;
          flex-direction: column;
          height: 100vh;
      }

      video {
          height: 100%;
          width: auto;
      }

      .controls {
          position: absolute;
          z-index: 100;
      }

      button {
          background: white;
          padding-left: 1rem;
          padding-right: 1rem;
          border: none;
      }
  </style>
</head>
<body>
<article id="app">
  <section>
    <audio :src-object.prop.camel="audioObject1"
           :autoplay="true"
           ref="audio1"
    ></audio>
    <video :src-object.prop.camel="videoObject1"
           :autoplay="true"
           :muted="true"
           :controls="false">
    </video>
    <div class="controls">
      <button @mousedown="control('demo1', 'start', 'Left')"
              @mouseup="control('demo1', 'stop', 'Left')">
        ⬅️
      </button>
      <button @mousedown="control('demo1', 'start', 'Right')"
              @mouseup="control('demo1', 'stop', 'Right')">
        ➡️
      </button>
      <button @mousedown="control('demo1', 'start', 'Up')"
              @mouseup="control('demo1', 'stop', 'Up')">
        ⬆️
      </button>
      <button @mousedown="control('demo1', 'start', 'Down')"
              @mouseup="control('demo1', 'stop', 'Down')">
        ⬇️
      </button>
    </div>
  </section>
  <section>
    <audio :src-object.prop.camel="audioObject2" :autoplay="true" ref="audio2"></audio>
    <video
            :src-object.prop.camel="videoObject2"
            :autoplay="true"
            :muted="true"
            :controls="false">
    </video>
    <div class="controls">
      <button @mousedown="control('demo2', 'start', 'Left')"
              @mouseup="control('demo2', 'stop', 'Left')">
        ⬅️
      </button>
      <button @mousedown="control('demo2', 'start', 'Right')"
              @mouseup="control('demo2', 'stop', 'Right')">
        ➡️
      </button>
      <button @mousedown="control('demo2', 'start', 'Up')"
              @mouseup="control('demo2', 'stop', 'Up')">
        ⬆️
      </button>
      <button @mousedown="control('demo2', 'start', 'Down')"
              @mouseup="control('demo2', 'stop', 'Down')">
        ⬇️
      </button>
    </div>
  </section>
</article>
<script>
  const app = new Vue({
    el: '#app',
    data: {
      audioObject1: null,
      audioObject2: null,
      videoObject1: null,
      videoObject2: null,
      pc1: null,
      pc2: null
    },
    mounted() {
      // creates peer connection and sets callbacks
      const pc = this.setupConnection('demo1', event => {
        console.log(event.streams.length + ' track is delivered')
        if (event.track.kind === 'video') {
          this.videoObject1 = event.streams[0]
        } else if (event.track.kind === 'audio') {
          this.audioObject1 = event.streams[0]
        }
      })
      this.$refs.audio1.volume = 1
      this.pc1 = pc

      // const pc2 = this.setupConnection('demo2', event => {
      //   console.log(event.streams.length + ' track is delivered')
      //   if (event.track.kind === 'video') {
      //     this.videoObject2 = event.streams[0]
      //   } else if (event.track.kind === 'audio') {
      //     this.audioObject2 = event.streams[0]
      //   }
      // })
      // this.getCodecInfo('demo2', pc2)
      // this.$refs.audio2.volume = 1
      // this.pc2 = pc2
    },
    methods: {
      async control(id, cmd, dir) {
        const r = await fetch(`control/${id}`, {
          method: 'POST',
          body: JSON.stringify({
            cmd,
            dir
          }),
          headers: {'Content-Type': 'application/json'}
        })
        if (!r.ok) {
          alert(await r.json())
        }
      },
      async setupConnection(id, cb) {
        console.log("Setup connection")

        const ws = await new Promise(function(resolve, reject) {
          const ws = new WebSocket(`ws://${location.host}/ws`)
          ws.onopen = function() {
            resolve(ws)
          }
          ws.onerror = function(err) {
            reject(err)
          }
        })
        console.log("Websocket connected")

        const pc = new RTCPeerConnection({
          iceServers: [{
            urls: ["stun:stun.l.google.com:19302"]
          }]
        })
        pc.onnegotiationneeded = async () => {
          console.log('negotiationneeded -- sending offer')
          let offer = await pc.createOffer()
          await pc.setLocalDescription(offer)
          ws.send(JSON.stringify({
            suuid: id,
            data: btoa(pc.localDescription.sdp)
          }))

          const iceTransport = pc.getSenders()[0].transport.iceTransport

          iceTransport.onselectedcandidatepairchange = function(event) {
            const pair = iceTransport.getSelectedCandidatePair()
            console.log('selectedcandidatepairchange -- local:', pair.local.type, pair.local.protocol, pair.local.port, 'remote:', pair.remote.type, pair.remote.protocol, pair.remote.port)
          }
        }
        pc.ontrack = cb
        pc.onconnectionstatechange = e => console.log('connectionstatechange', pc.connectionState)
        pc.oniceconnectionstatechange = e => console.log('iceconnectionstatechange', pc.iceConnectionState)
        pc.onicegatheringstatechange = e => console.log('icegatheringstatechange', pc.iceGatheringState)
        pc.onicecandidate = e => {
          console.log('icecandidate', e.candidate ? e.candidate.candidate : null)
          if (e.candidate == null) {
            return
          }
          ws.send(JSON.stringify(e.candidate.toJSON()))
        }
        pc.onicecandidateerror = e => console.log('icecandidateerror', e)
        pc.onsignalingstatechange = e => console.log('signalingstatechange', e)

        // TODO add based on data from server
        pc.addTransceiver('audio', {
          direction: 'sendrecv'
        })
        pc.addTransceiver('video', {
          direction: 'sendrecv'
        })

        ws.onmessage = e => {
          const msg = JSON.parse(e.data)
          if (msg.sdp) {
            console.log("Got answer")
            pc.setRemoteDescription(new RTCSessionDescription({
              type: 'answer',
              sdp: msg.sdp
            }))
          } else if (msg.candidate) {
            console.log("Got remote ICE candidate")
            pc.addIceCandidate(msg)
          } else {
            console.log("Unknown Websocket Message", msg)
          }
        }

        return pc
      }
    }
  })
</script>
</body>
</html>
